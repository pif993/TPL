<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TPL · OTA Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta3/dist/css/adminlte.min.css" rel="stylesheet">
  <link href="/design-tokens.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary sb-collapsed">
  <div class="app-wrapper">

    <!-- Navbar -->
    <nav class="app-header navbar navbar-expand bg-body">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" id="sidebarToggle" href="#" role="button"><i class="bi bi-list"></i></a></li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="#" onclick="TPL.logout();return false" title="Logout"><i class="bi bi-box-arrow-right"></i></a></li>
        </ul>
      </div>
    </nav>

    <div id="sidebarMount"></div>

    <main class="app-main">
      <div class="app-content">
        <div class="container-fluid p-3 p-lg-4">

          <!-- ═══ HERO: Version Transition ═══════════════════════ -->
          <div class="ota-pipe-hero">
            <div class="ota-pipe-hero-bg"></div>
            <!-- Ambient orbs (login DNA) -->
            <div class="ota-pipe-orb ota-pipe-orb--1"></div>
            <div class="ota-pipe-orb ota-pipe-orb--2"></div>
            <div class="ota-pipe-hero-content">
              <div class="ota-pipe-hero-left">
                <h2 class="ota-pipe-hero-title">
                  <i class="bi bi-cloud-arrow-down-fill"></i> OTA Manager
                </h2>
                <p class="ota-pipe-hero-sub">Aggiornamenti completamente automatizzati · Ed25519 + SHA-256</p>
              </div>
              <div class="ota-pipe-hero-versions">
                <div class="ota-pipe-ver ota-pipe-ver--current">
                  <small>Corrente</small>
                  <strong id="otaHeroCurrentVer">—</strong>
                </div>
                <div class="ota-pipe-ver-arrow" id="otaHeroArrow" style="display:none">
                  <i class="bi bi-arrow-right-circle-fill"></i>
                </div>
                <div class="ota-pipe-ver ota-pipe-ver--new" id="otaHeroNewVer" style="display:none">
                  <small>Disponibile</small>
                  <strong id="otaHeroLatestVer">—</strong>
                </div>
              </div>
              <div class="ota-pipe-hero-badges">
                <span class="ota-pipe-badge" id="otaHeroBadge"><i class="bi bi-hourglass-split"></i> Verifica…</span>
                <span class="ota-pipe-badge ota-pipe-badge--sec" id="otaHeroSecBadge"><i class="bi bi-shield-lock-fill"></i> —</span>
              </div>
            </div>
          </div>

          <!-- Repo Status Warning (shown dynamically when repo not found) -->
          <div id="otaRepoStatus" style="display:none"></div>

          <!-- ═══ PIPELINE CARD (main focus) ═════════════════════ -->
          <div class="ota-pipe-card ota-pipe-card--main">
            <div class="ota-pipe-card-head">
              <span class="ota-pipe-card-title"><i class="bi bi-lightning-charge-fill"></i> Pipeline di Aggiornamento</span>
              <span class="ota-pipe-pill" id="otaPipePill">idle</span>
            </div>

            <!-- Pipeline Stepper -->
            <div class="ota-pipe-stepper" id="otaPipeStepper">
              <div class="ota-pipe-step" data-step="check">
                <div class="ota-pipe-step-icon"><i class="bi bi-search"></i></div>
                <div class="ota-pipe-step-label">Verifica</div>
              </div>
              <div class="ota-pipe-step-line"></div>
              <div class="ota-pipe-step" data-step="prepare">
                <div class="ota-pipe-step-icon"><i class="bi bi-download"></i></div>
                <div class="ota-pipe-step-label">Prepara</div>
              </div>
              <div class="ota-pipe-step-line"></div>
              <div class="ota-pipe-step" data-step="verify">
                <div class="ota-pipe-step-icon"><i class="bi bi-shield-check"></i></div>
                <div class="ota-pipe-step-label">Verifica Sicurezza</div>
              </div>
              <div class="ota-pipe-step-line"></div>
              <div class="ota-pipe-step" data-step="apply">
                <div class="ota-pipe-step-icon"><i class="bi bi-gear-wide-connected"></i></div>
                <div class="ota-pipe-step-label">Applica</div>
              </div>
              <div class="ota-pipe-step-line"></div>
              <div class="ota-pipe-step" data-step="finalize">
                <div class="ota-pipe-step-icon"><i class="bi bi-check-circle"></i></div>
                <div class="ota-pipe-step-label">Completa</div>
              </div>
            </div>

            <!-- CTA + Status Area -->
            <div class="ota-pipe-cta-area">
              <button class="ota-pipe-cta" id="otaPipeCta" type="button">
                <i class="bi bi-arrow-repeat" id="otaPipeCtaIcon"></i>
                <span id="otaPipeCtaText">Verifica aggiornamenti</span>
              </button>
              <div class="ota-pipe-status" id="otaPipeStatus">
                <span class="text-muted small">Pronto per la verifica</span>
              </div>
            </div>

            <!-- Real-time Pipeline Log -->
            <div class="ota-pipe-log-wrap" id="otaPipeLogWrap" style="display:none">
              <div class="ota-pipe-log-head">
                <i class="bi bi-terminal-fill"></i> Log Pipeline
                <button class="ota-pipe-log-toggle" id="otaPipeLogToggle" type="button" title="Comprimi"><i class="bi bi-chevron-up"></i></button>
              </div>
              <div class="ota-pipe-log" id="otaPipeLog"></div>
            </div>

            <!-- Install Controls (shown only during/after install) -->
            <div class="ota-pipe-controls d-none" id="otaPipeControls">
              <button class="ota-pipe-btn ota-pipe-btn--danger" id="otaPipeRollbackBtn" type="button" disabled>
                <i class="bi bi-arrow-counterclockwise"></i> Rollback
              </button>
              <button class="ota-pipe-btn" id="otaPipeCancelBtn" type="button" disabled>
                <i class="bi bi-x-circle"></i> Annulla
              </button>
            </div>
          </div>

          <!-- ═══ MAIN GRID: Releases + Security ════════════════ -->
          <div class="ota-pipe-grid">

            <!-- LEFT: Releases -->
            <div class="ota-pipe-col-main">
              <div class="ota-pipe-card">
                <div class="ota-pipe-card-head">
                  <span class="ota-pipe-card-title"><i class="bi bi-tag-fill"></i> Release</span>
                  <span class="ota-pipe-pill" id="otaRelPill">—</span>
                  <button class="ota-pipe-btn ota-pipe-btn--sm ms-auto" id="otaCheckBtn" type="button" title="Verifica">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
                <div class="ota-pipe-card-body" id="otaReleaseList">
                  <div class="ota-pipe-skeleton"><div class="ota-pipe-skel-line"></div><div class="ota-pipe-skel-line w-75"></div></div>
                </div>
              </div>

              <!-- Detail Panel (hidden by default) -->
              <div class="ota-pipe-card d-none" id="otaDetailPanel">
                <div class="ota-pipe-card-head">
                  <span class="ota-pipe-card-title"><i class="bi bi-info-circle-fill"></i> Dettaglio</span>
                  <button class="ota-pipe-card-close" id="otaDetailCloseBtn" type="button"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="ota-pipe-card-body" id="otaDetailContent"></div>
              </div>

              <!-- Security Results (shown on verify/simulate) -->
              <div id="otaSecResults" class="d-none"></div>
            </div>

            <!-- RIGHT: Security + Config -->
            <div class="ota-pipe-col-side">

              <!-- Security Status -->
              <div class="ota-pipe-card ota-pipe-card--sec">
                <div class="ota-pipe-card-head">
                  <span class="ota-pipe-card-title"><i class="bi bi-shield-lock-fill"></i> Sicurezza</span>
                  <span class="ota-pipe-sec-badge" id="otaSecBadge"><i class="bi bi-shield-check"></i> —</span>
                </div>
                <div class="ota-pipe-card-body">
                  <div class="ota-pipe-sec-keys">
                    <div class="ota-pipe-sec-row"><i class="bi bi-key-fill"></i><span>Publisher</span><span id="otaSecPubKey">—</span></div>
                    <div class="ota-pipe-sec-row"><i class="bi bi-cpu-fill"></i><span>Platform</span><span id="otaSecPlatKey">—</span></div>
                    <div class="ota-pipe-sec-row"><i class="bi bi-fingerprint"></i><span>Algoritmi</span><span id="otaSecAlgo">—</span></div>
                    <div class="ota-pipe-sec-row"><i class="bi bi-link-45deg"></i><span>Chain</span><span id="otaSecChain">—</span></div>
                    <div class="ota-pipe-sec-row"><i class="bi bi-pin-map-fill"></i><span>TOFU</span><span id="otaSecTofu">—</span></div>
                  </div>

                  <div class="ota-pipe-sec-actions">
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaSecChainBtn" type="button"><i class="bi bi-link-45deg"></i> Chain</button>
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaSecRepairBtn" type="button" style="display:none"><i class="bi bi-wrench"></i> Ripara</button>
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaSecSimBtn" type="button"><i class="bi bi-play-circle"></i> Simula</button>
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaSecRefreshBtn" type="button"><i class="bi bi-arrow-clockwise"></i></button>
                  </div>

                  <details class="ota-pipe-details">
                    <summary><i class="bi bi-sliders2"></i> Policy &amp; Lockdown</summary>
                    <div class="ota-pipe-details-body">
                      <label class="ota-pipe-toggle"><span>Firma obbligatoria</span><input class="form-check-input" type="checkbox" id="otaSecCfgSig" checked></label>
                      <label class="ota-pipe-toggle"><span>Checksum obbligatorio</span><input class="form-check-input" type="checkbox" id="otaSecCfgCheck" checked></label>
                      <label class="ota-pipe-toggle"><span>Quarantena sospetti</span><input class="form-check-input" type="checkbox" id="otaSecCfgQuar" checked></label>
                      <label class="ota-pipe-toggle"><span>Rischio max</span><input type="number" class="form-control form-control-sm" id="otaSecCfgRisk" value="30" min="0" max="100" style="width:56px"></label>
                      <div class="ota-pipe-details-actions">
                        <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaSecCfgSaveBtn" type="button"><i class="bi bi-check-lg"></i> Salva</button>
                        <span id="otaSecCfgResult" class="small"></span>
                      </div>
                      <hr class="my-2 opacity-25">
                      <div class="d-flex align-items-center gap-2">
                        <span id="otaLockdownStatus"><i class="bi bi-unlock-fill"></i> Inattivo</span>
                        <button class="ota-pipe-btn ota-pipe-btn--sm ota-pipe-btn--danger" id="otaLockdownBtn" type="button"><i class="bi bi-lock-fill"></i> Lockdown</button>
                      </div>
                    </div>
                  </details>
                </div>
              </div>

              <!-- Config -->
              <div class="ota-pipe-card">
                <div class="ota-pipe-card-head">
                  <span class="ota-pipe-card-title"><i class="bi bi-gear-wide-connected"></i> Config</span>
                </div>
                <div class="ota-pipe-card-body">
                  <label class="ota-pipe-toggle"><span>Auto-check</span><input class="form-check-input" type="checkbox" id="otaCfgAuto" checked></label>
                  <div class="d-flex gap-2 align-items-center mb-1">
                    <label class="ota-pipe-cfg-field mb-0"><span>Intervallo</span><input type="number" class="form-control form-control-sm" id="otaCfgInterval" value="60" min="15" max="1440" style="width:56px"><span class="text-muted" style="font-size:.65rem">min</span></label>
                    <label class="ota-pipe-cfg-field mb-0"><span>Branch</span><input type="text" class="form-control form-control-sm" id="otaCfgBranch" value="main" style="width:72px"></label>
                  </div>
                  <label class="ota-pipe-toggle"><span>Pre-release</span><input class="form-check-input" type="checkbox" id="otaCfgPre"></label>
                  <div class="d-flex align-items-center gap-2">
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaCfgSaveBtn" type="button"><i class="bi bi-check-lg"></i> Salva</button>
                    <span id="otaCfgResult" class="small"></span>
                  </div>
                </div>
              </div>

              <!-- Test Update (collapsible) -->
              <details class="ota-pipe-card">
                <summary class="ota-pipe-card-head" style="cursor:pointer;list-style:none">
                  <span class="ota-pipe-card-title"><i class="bi bi-box-seam-fill"></i> Test Update</span>
                  <span class="ota-pipe-pill" id="otaTestPill">—</span>
                </summary>
                <div class="ota-pipe-card-body">
                  <div id="otaTestInfo"><span class="text-muted small">Nessun test update</span></div>
                  <div class="d-flex gap-1 flex-wrap mt-2">
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaTestCreateBtn" type="button"><i class="bi bi-plus-circle"></i> Crea</button>
                    <button class="ota-pipe-btn ota-pipe-btn--sm ota-pipe-btn--primary" id="otaTestDeliverBtn" type="button" disabled><i class="bi bi-send"></i> Consegna</button>
                    <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaTestVerifyBtn" type="button" disabled><i class="bi bi-shield-check"></i> Verifica</button>
                    <button class="ota-pipe-btn ota-pipe-btn--sm ota-pipe-btn--danger" id="otaTestCleanBtn" type="button" disabled><i class="bi bi-trash3"></i> Rimuovi</button>
                  </div>
                  <div id="otaTestResult" class="mt-2 small"></div>
                </div>
              </details>
            </div>
          </div>

          <!-- ═══ BOTTOM: Changelog + Rollback/Snapshots ════════ -->
          <div class="ota-pipe-bottom">
            <div class="ota-pipe-card">
              <div class="ota-pipe-card-head">
                <span class="ota-pipe-card-title"><i class="bi bi-journal-text"></i> Changelog</span>
              </div>
              <div class="ota-pipe-card-body ota-pipe-scroll" id="otaChangelog">
                <div class="ota-pipe-skeleton"><div class="ota-pipe-skel-line"></div><div class="ota-pipe-skel-line w-75"></div></div>
              </div>
            </div>
            <div class="ota-pipe-card">
              <div class="ota-pipe-card-head">
                <span class="ota-pipe-card-title"><i class="bi bi-arrow-counterclockwise"></i> Rollback &amp; Snapshot</span>
                <span class="ota-pipe-pill" id="otaRbPill">—</span>
              </div>
              <div class="ota-pipe-card-body ota-pipe-scroll" id="otaRollbackList">
                <div class="ota-pipe-skeleton"><div class="ota-pipe-skel-line"></div></div>
              </div>
              <div class="ota-pipe-card-body ota-pipe-scroll" id="otaSnapshotList" style="border-top:1px solid rgba(0,0,0,.06)">
                <div class="ota-pipe-skeleton"><div class="ota-pipe-skel-line w-50"></div></div>
              </div>
              <div class="px-3 pb-2 d-flex align-items-center gap-2">
                <button class="ota-pipe-btn ota-pipe-btn--sm" id="otaSnapCreateBtn" type="button"><i class="bi bi-camera"></i> Snapshot</button>
                <span class="ota-pipe-pill" id="otaSnapPill">—</span>
              </div>
            </div>
          </div>

          <!-- Toast -->
          <div id="otaToast" class="d-none" role="alert" aria-live="polite"></div>

          <div class="ota-pipe-shortcuts">
            <kbd>R</kbd> aggiorna <kbd>C</kbd> verifica <kbd>S</kbd> simula <kbd>U</kbd> aggiorna <kbd>Esc</kbd> chiudi
          </div>

        </div>
      </div>
    </main>

    <footer class="app-footer">
      <div class="float-end d-none d-sm-inline"><span class="tpl-version-badge" id="tplVersionBadge">v3.1.0</span></div>
      <strong>&copy; TPL Fortress</strong>
    </footer>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/app.js"></script>
  <script src="/sidebar.js?v=3.3"></script>
  <script>
    (async () => {
      try {
        const me = await TPL.jsonFetch('/api/me');
        if (me.roles && me.roles.includes('admin')) TPLSidebar.setAdmin(true);
        TPLSidebar.setUser(me.sub || '—');
        const g = document.getElementById('otaHeroBadge');
        if (g) { g.className = 'ota-pipe-badge'; g.innerHTML = `<i class="bi bi-person-check-fill"></i> ${me.sub}`; }
      } catch { location.href = '/'; }
    })();
  </script>
  <script src="/ota.js?v=5.0"></script>
</body>
</html>
