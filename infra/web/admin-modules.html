<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TPL · Admin Modules</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/admin-lte@4.0.0-beta3/dist/css/adminlte.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary sb-collapsed">
  <div class="app-wrapper">

    <!-- Top Navbar -->
    <nav class="app-header navbar navbar-expand bg-body">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" id="sidebarToggle" href="#" role="button" aria-label="Toggle sidebar"><i class="bi bi-list"></i></a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-danger" href="#" onclick="TPL.logout();return false" aria-label="Logout" title="Logout"><i class="bi bi-box-arrow-right"></i></a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Sidebar (rendered by sidebar.js) -->
    <div id="sidebarMount"></div>

    <!-- Main Content -->
    <main class="app-main">
      <div class="app-content-header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-sm-6"><h3 class="mb-0"><i class="bi bi-puzzle me-2"></i>Gestione Moduli</h3></div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-end">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Moduli</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <div class="app-content">
        <div class="container-fluid">

          <!-- Hero -->
          <div class="ov-hero">
            <div class="ov-hero-left">
              <h2 class="ov-hero-title"><i class="bi bi-box-seam me-2"></i>Distribuzione Moduli</h2>
              <p class="ov-hero-sub">Gestione bundle firmati, release e integrità — aggiornamenti via <code>tpl-modules</code> CLI</p>
            </div>
            <div class="ov-hero-right">
              <span class="ov-role-chip" id="g"><i class="bi bi-hourglass-split"></i> Verifica…</span>
            </div>
          </div>

          <!-- Bundle Info + Security Checklist -->
          <div class="row g-3 mb-3">
            <div class="col-12 col-lg-7">
              <div class="ov-panel">
                <div class="ov-panel-head">
                  <span><i class="bi bi-archive"></i> Bundle Corrente</span>
                  <button class="btn btn-outline-primary btn-sm" id="amRefreshBundle" type="button"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="ov-panel-body" id="amBundleInfo">
                  <div class="ov-placeholder"><div class="ov-placeholder-pulse"></div></div>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-5">
              <div class="ov-panel">
                <div class="ov-panel-head"><span><i class="bi bi-shield-check"></i> Security Checklist</span><span class="ov-pill" id="amSecPill">—</span></div>
                <div class="ov-panel-body" id="amSecChecklist">
                  <div class="ov-placeholder"><div class="ov-placeholder-pulse"></div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Module List (read-only) -->
          <div class="ov-panel mb-3">
            <div class="ov-panel-head">
              <span><i class="bi bi-grid-3x3-gap"></i> Moduli Installati</span>
              <span class="ov-pill ov-pill--info" id="amCountPill">—</span>
            </div>
            <div class="ov-panel-body">
              <div id="amStats"></div>
              <div class="am-toolbar">
                <input type="search" class="form-control form-control-sm" id="amSearch" placeholder="Cerca moduli…" style="max-width:240px">
                <select class="form-select form-select-sm" id="amFilter" style="max-width:160px">
                  <option value="all">Tutti</option>
                  <option value="installed">Installati</option>
                  <option value="available">Disponibili</option>
                </select>
                <div class="am-view-toggle">
                  <button class="am-view-btn active" data-view="grid" title="Vista griglia"><i class="bi bi-grid-3x3-gap-fill"></i></button>
                  <button class="am-view-btn" data-view="list" title="Vista lista"><i class="bi bi-list-ul"></i></button>
                </div>
              </div>
              <div id="ml" style="min-height:120px">
                <div class="ov-placeholder"><div class="ov-placeholder-pulse"></div></div>
              </div>
            </div>
          </div>

          <!-- Release History + Integrity -->
          <div class="row g-3 mb-3">
            <div class="col-12 col-lg-6">
              <div class="ov-panel">
                <div class="ov-panel-head"><span><i class="bi bi-clock-history"></i> Release</span><span class="ov-pill" id="amRelPill">—</span></div>
                <div class="ov-panel-body" id="amReleases" style="max-height:320px;overflow-y:auto">
                  <div class="ov-placeholder"><div class="ov-placeholder-pulse"></div></div>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="ov-panel">
                <div class="ov-panel-head"><span><i class="bi bi-fingerprint"></i> Integrità</span></div>
                <div class="ov-panel-body" id="amIntegrity" style="max-height:320px;overflow-y:auto">
                  <div class="ov-placeholder"><div class="ov-placeholder-pulse"></div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Distribution Config -->
          <div class="ov-panel mb-3">
            <div class="ov-panel-head"><span><i class="bi bi-gear"></i> Configurazione Distribuzione</span></div>
            <div class="ov-panel-body" id="amDistConfig">
              <div class="ov-placeholder"><div class="ov-placeholder-pulse"></div></div>
            </div>
          </div>

          <!-- CLI Instructions -->
          <div class="ov-panel">
            <div class="ov-panel-head"><span><i class="bi bi-terminal"></i> Gestione via CLI</span></div>
            <div class="ov-panel-body">
              <p class="am-cli-note">L'installazione, l'aggiornamento e il rollback dei moduli avviene esclusivamente via il CLI <code>tpl-modules</code>. L'API è in sola lettura.</p>
              <div class="am-cli-grid">
                <div class="am-cli-item"><code class="am-cli-cmd">tpl-modules pack</code><span class="am-cli-desc">Crea un bundle firmato</span></div>
                <div class="am-cli-item"><code class="am-cli-cmd">tpl-modules verify &lt;bundle&gt;</code><span class="am-cli-desc">Verifica firma e checksum</span></div>
                <div class="am-cli-item"><code class="am-cli-cmd">tpl-modules install &lt;bundle&gt;</code><span class="am-cli-desc">Installa atomicamente</span></div>
                <div class="am-cli-item"><code class="am-cli-cmd">tpl-modules rollback</code><span class="am-cli-desc">Ripristina release precedente</span></div>
                <div class="am-cli-item"><code class="am-cli-cmd">tpl-modules list</code><span class="am-cli-desc">Elenca release installate</span></div>
                <div class="am-cli-item"><code class="am-cli-cmd">tpl-modules security-check</code><span class="am-cli-desc">Checklist sicurezza</span></div>
              </div>
            </div>
          </div>

          <!-- Keyboard shortcuts -->
          <div class="text-muted text-center mt-3 mb-2" style="font-size:.68rem;opacity:.5">
            <kbd>R</kbd> aggiorna &nbsp; <kbd>/</kbd> cerca &nbsp; <kbd>G</kbd> griglia/lista
          </div>

        </div>
      </div>
    </main>

    <footer class="app-footer">
      <div class="float-end d-none d-sm-inline">v3.0</div>
      <strong>&copy; TPL Platform</strong>
    </footer>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/app.js"></script>
  <script src="/sidebar.js"></script>
  <script>
    // Enable admin sidebar items and apply i18n on sub-pages
    (async () => {
      try {
        const me = await TPL.jsonFetch('/api/me');
        if (me.roles && me.roles.includes('admin')) {
          TPLSidebar.setAdmin(true);
        }
        TPLSidebar.setUser(me.sub || '—');
        if (typeof TPL.applyI18n === 'function') TPL.applyI18n();
      } catch (e) {
        // Not authenticated — redirect to login
        location.href = '/';
      }
    })();
  </script>
  <script src="/admin-modules.js"></script>
</body>
</html>
