server {
  listen 80;
  server_name _;
  server_tokens off;
  root /usr/share/nginx/html;
  index index.html;

  # ── Fortress security headers (single source of truth) ─────────
  # All location blocks include security-headers.conf — no duplication.
  # Edit security-headers.conf once to change headers everywhere.
  set $csp "default-src 'self'; connect-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' https://cdn.jsdelivr.net; font-src 'self' data: https://cdn.jsdelivr.net; base-uri 'self'; form-action 'self'; frame-ancestors 'none'";

  # ── Route aliases → unified dashboard ────────────────────────
  location = /login {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /index.html =404;
  }

  location = /dashboard {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /dashboard.html =404;
  }

  location = /dashboard/user {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /dashboard.html =404;
  }

  location = /dashboard/admin {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /dashboard.html =404;
  }

  location = /admin {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /admin.html =404;
  }

  location = /admin/modules {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /admin-modules.html =404;
  }

  location = /ota {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /ota.html =404;
  }

  location = /diagnostics {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /diagnostics.html =404;
  }

  location = /advanced {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store" always;
    try_files /advanced.html =404;
  }

  # ── Legacy redirects (deleted files → dashboard) ─────────────
  location = /dashboard-admin.html    { return 301 /dashboard; }
  location = /dashboard-user.html     { return 301 /dashboard; }
  location = /dashboard-admin-v2.html { return 301 /dashboard; }

  # ── HTML files: no cache ─────────────────────────────────────
  location ~* \.html$ {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma        "no-cache" always;
    add_header Expires       "0"        always;
  }

  # ── JS files: revalidate on every request (ETag) ─────────────
  location ~* \.js$ {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-cache, must-revalidate" always;
    etag on;
    try_files $uri =404;
  }

  # ── Static assets: long cache with immutable ─────────────────
  location ~* \.(css|woff2?|ttf|eot|svg|png|jpg|ico)$ {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "public, max-age=86400, immutable" always;
    try_files $uri =404;
  }

  # ── Default: SPA fallback ────────────────────────────────────
  location / {
    include /etc/nginx/conf.d/security-headers.conf;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma        "no-cache" always;
    add_header Expires       "0"        always;
    try_files $uri $uri/ /index.html;
  }
}
